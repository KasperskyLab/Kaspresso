
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://kasperskylab.github.io/Kaspresso/en/Tutorial/Android_permissions/">
      
      
        <link rel="prev" href="../FlakySafely/">
      
      
        <link rel="next" href="../Recyclerview/">
      
      
      <link rel="icon" href="../../../kaspresso.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>10. Working with Android permissions - Kaspresso</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#test-apps-that-require-permissions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../" title="Kaspresso" class="md-header__button md-logo" aria-label="Kaspresso" data-md-component="logo">
      
  <img src="../../../kaspresso.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kaspresso
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              10. Working with Android permissions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/Kaspresso/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/Kaspresso/ru/" hreflang="ru" class="md-select__link">
              Русский
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/KasperskyLab/Kaspresso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Kaspresso
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../" class="md-tabs__link">
          
  
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Tutorial

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Wiki/" class="md-tabs__link">
          
  
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Issues/" class="md-tabs__link">
          
  
  
  Issues

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Kaspresso" class="md-nav__button md-logo" aria-label="Kaspresso" data-md-component="logo">
      
  <img src="../../../kaspresso.png" alt="logo">

    </a>
    Kaspresso
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KasperskyLab/Kaspresso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Kaspresso
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso-in-articles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso in articles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso-in-videos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso in videos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso%20users/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Our users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Breaking-changes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breaking changes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Contribution_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contribution guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Download_Kaspresso_project_and_Android_studio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2. Download Kaspresso project and Android studio
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Writing_simple_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3. Writing your first Kaspresso test
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Working_with_adb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4. Working with adb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Wifi_sample_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5. Testing the Internet connection and working with the Device class
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Steps_and_sections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6. Steps and sections
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Scenario/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7. Reduce duplicate steps the Scenario
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../UiAutomator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8. Kautomator. Third Party Application Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FlakySafely/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9. flakySafely
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    10. Working with Android permissions
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    10. Working with Android permissions
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Create a test
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-the-testrule" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with the TestRule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flakysafely-for-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      FlakySafely for assertions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-devicepermissions" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with Device.Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-against-different-api-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Testing against different API versions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Recyclerview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11. RecyclerView. Testing list of elements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Logger_and_screenshot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12. Logger and screenshots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Screenshot_tests_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13. Screenshot-tests. Part 1. Simple screenshot-test
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Screenshot_tests_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14. Screenshot-tests. Part 2. Working with ViewModel and setting states
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Wiki
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wiki
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Page_object_in_Kaspresso/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PageObject in Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Espresso_as_the_basis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Espresso as the basis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Supported_Android_UI_elements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Supported Android UI-elements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Matchers_actions_assertions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    View matchers, actions and assertions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kautomator-wrapper_over_UI_Automator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kautomator. Wrapper over UI Automator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Working_with_Android_OS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Android OS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Executing_adb_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Executing adb commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Screenshot_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Screenshot tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_Robolectric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso with Robolectric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_Allure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso with Allure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Jetpack_Compose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compose support in Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Issues
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Issues
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Found an issue?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Issues/Storage_issue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage issues
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Create a test
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-the-testrule" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with the TestRule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flakysafely-for-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      FlakySafely for assertions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-devicepermissions" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with Device.Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-against-different-api-versions" class="md-nav__link">
    <span class="md-ellipsis">
      Testing against different API versions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="test-apps-that-require-permissions">Test apps that require permissions</h1>
<p>In this tutorial, we will learn how to work with permissions (<a href="https://developer.android.com/guide/topics/permissions/overview">Permissions</a>).</p>
<p>Often, in order to work correctly, an application needs access to certain functions of the mobile device: to the camera, voice recording, making calls, sending SMS messages, etc. The application can access and use them only if the user gives permission to do so.</p>
<p>On older devices below the sixth version of Android (API level 23), such permissions were requested at the time the application was installed, and if the user installed it, it was considered that he agreed with all the permissions, and the application would be able to use all the necessary functions. This was unsafe, as it opened up the possibility for unscrupulous developers to gain access to the microphone, camera, calls and other important components without the user noticing and use it for their own purposes.</p>
<p>For this reason, on newer versions, the so-called "dangerous" permissions began to be requested not at the time of installation, but while the application was running. Now the user will clearly see a dialog with a proposal to allow or deny a request to use some functionality.</p>
<p>For example, run the <code>tutorial</code> application on one of the latest versions of Android (API 23 and above) and press the <code>Make Call Activity</code> button</p>
<p><img src="../images/permissions/main_screen.png" alt="Main Screen" width="300"/></p>
<p>You will see a screen on which there are two elements - an input field and a button. In the input field, you can specify some phone number and click on the <code>Make Call</code> button to make a call</p>
<p><img src="../images/permissions/make_call_screen.png" alt="Make call screen" width="300"/></p>
<p>Making calls is one of the features that requires permission from the user to work. Therefore, you will see a dialog asking you to allow the application to control calls, which has "Allow" and "Reject" buttons.</p>
<p><img src="../images/permissions/request_permission_1.png" alt="Request permissions" width="300"/></p>
<p>If we click “Allow”, then the call will begin to the subscriber at the number that you specified in the input field</p>
<p><img src="../images/permissions/call_1.png" alt="Calling" width="300"/></p>
<p>The next time you open the application, the permission will no longer be requested, it is saved on the device. If you want to revoke permission, you can do so in the settings. To do this, go to the application section, find the one you need and go to the <code>Permissions</code> section</p>
<p><img src="../images/permissions/deny_permission_settings.png" alt="Deny permission" width="300"/></p>
<p>Here you can go to any permission and change the value from <code>Allow</code> to <code>Deny</code> or vice versa.</p>
<p>The second way to do this is with the adb shell command:</p>
<p><code>adb shell pm revoke package_name permission_name</code></p>
<p>For our application, the command will look like this:</p>
<p><code>adb shell pm revoke com.kaspersky.kaspresso.tutorial android.permission.CALL_PHONE</code></p>
<p>After executing the command, the application will ask for permission again the next time you try to make a call.</p>
<h2 id="create-a-test">Create a test</h2>
<p>When testing applications that require permissions, there are certain considerations. Let's write a test for this screen.</p>
<p>First of all, let's create a Page Object of the screen with the <code>Make Call</code> button</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen</span>

<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.screens.KScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.R</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.edit.KEditText</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.text.KButton</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">MakeCallActivityScreen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KScreen</span><span class="o">&lt;</span><span class="n">MakeCallActivityScreen</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">layoutId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewClass</span><span class="p">:</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;*&gt;?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">inputNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEditText</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">input_number</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">makeCallButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To get to this screen, you will need to click on the corresponding button in <code>MainActivity</code>, add this button to <code>MainScreen</code></p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen</span>

<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.screens.KScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.R</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.text.KButton</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">MainScreen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KScreen</span><span class="o">&lt;</span><span class="n">MainScreen</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">layoutId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewClass</span><span class="p">:</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;*&gt;?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">simpleActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">simple_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">wifiActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">wifi_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">loginActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">login_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">notificationActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">notification_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">makeCallActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">make_call_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>We can create a test. For now, let's just open the screen for making a call, enter some number and click on the button</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Let's run the test. Test passed successfully.</p>
<p>Depending on whether you have given permission or not, you may see a dialog asking permission to make calls.</p>
<p>At this stage, we have checked the operation of our screen, that it is possible to enter a number and click on the button, but we have not checked in any way whether a call is being made to the entered number or not. To check if a call is currently in progress, you can use <code>AudioManager</code>, this is done as follows:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
</code></pre></div>
<p>We can add this check in a separate step:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">AudioManager</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<p>Before running the test, remove the application from the device or revoke permissions using the adb shell command. Also make sure you are running the test on a device with API 23 and higher.</p>
<p>Let's run the test. Test failed.</p>
<p>This happened because after clicking on the button, the user was asked for permission. No one gave this permission, and the next screen was not opened.</p>
<h2 id="testing-with-the-testrule">Testing with the TestRule</h2>
<p>There are several options for solving the problem. The first option is to use <code>GrantPermissionRule</code>. The essence of this method is that we create a list of permissions that will be automatically allowed on the device under test.</p>
<p>To do this, we add a new rule before the test method:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">    </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="p">)</span>
</code></pre></div>
<p>In the <code>grant</code> method, in parentheses, we list all the required permissions separated by commas, in this case there is only one, so we leave it as it is. Then the whole test code will look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<p>Remember to revoke all permissions from the app or remove it from the device before running the test.</p>
<p>Let's run the test. In some cases, this test will pass, and in others it will not. We will now analyze the reason.</p>
<h2 id="flakysafely-for-assertions">FlakySafely for assertions</h2>
<p>Remember the lesson about the <code>flakySafely</code> method. There we talked about the fact that in case of failure, all checks in Kaspresso will be restarted within a certain timeout.</p>
<p>In our case, we start the call and the next step is to check that the phone is really ringing. We do this through the <code>Assert.assertTrue(…)</code> method. Sometimes the device manages to dial the number before this check, and sometimes it does not. It seems that in such a situation the <code>flakySafely</code> method should work and the check should be carried out again within ten seconds, but for some reason this does not happen.</p>
<p>The fact is that all checks of view-elements in Kaspresso (isVisible, isClickable ...) "under the hood" use the <code>flakySafely</code> method, but if we ourselves call various checks through <code>assert</code>, then <code>flakySafely</code> will not be used and if the check fails, the test will immediately finished with failure.</p>
<p>Cases like this are another example of when you should explicitly call <code>flakySafely</code></p>
<p><div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Now the test works, but it has several problems.</p>
<p>Firstly, after the end of the test, the call to the subscriber is still ongoing on the device. Let's add the <code>before</code> and <code>after</code> sections and in the section that runs after the test, complete the call. This can be done with the following code: <code>device.phone.cancelCall("111")</code>. This method works through adb commands, so do not forget to start the adb server.</p>
<p>Theoretically, you could put the call reset in a separate step and run it as the last step without moving it to the after section. But this would be a bad decision, because if any step fails and the test fails, then the device will continue the call and never reset. The advantage of the after section is that the code inside this block will be executed regardless of the result of the test.</p>
<p>In order not to duplicate the same number in two places, let's move it to a separate variable, then the test code will look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Now, after the test is completed, the call ends.</p>
<p>The second problem is that when using <code>GrantPermissionRule</code> we can only check the application in the state where the user has given the permission. At the same time, it is possible that the developers did not foresee the option when the permission request was rejected, then the result may be unexpected up to the point that the application will crash. We need to check these scenarios too, but using <code>GrantPermissionRule</code> for this will not work, because in this case the permission will always be approved, and in tests we will never know what the behavior will be if the request is denied.</p>
<h2 id="testing-with-devicepermissions">Testing with Device.Permissions</h2>
<p>One of the solutions to the problem is to interact with the dialog using KAutomator, having previously found all the necessary interface elements, but this is not very convenient, and a much more convenient way has been added to the Kaspresso - <code>Device.Permissions</code>. It makes it very easy to check permission dialogs, as well as accept or reject them.</p>
<p>Therefore, instead of <code>Rule</code> we will use the <code>Permissions</code> object, which can be obtained from <code>Device</code>. Let's do this in a separate class so that you can keep both test cases. The class in which we are currently working will be renamed to <code>MakeCallActivityRuleTest</code>.</p>
<p>To do this, right-click on the file name and select <code>Refactor</code> -&gt; <code>Rename</code></p>
<p><img src="../images/permissions/rename.png" alt="Rename" /></p>
<p>And enter a new class name:</p>
<p><img src="../images/permissions/rename_2.png" alt="Rename" /></p>
<p>And create a new class <code>MakeCallActivityDevicePermissionsTest</code>. Code can be copied from the current test, except for <code>GrantPermissionRule</code></p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>If we run the test now, it will fail because we do not have needed permission to make calls. Let's add one more step in which we will give the appropriate permission through <code>device.permissions</code>. After specifying an object, you can put a dot and see what methods it has:</p>
<p><img src="../images/permissions/device_perm_methods.png" alt="Device permission methods"/></p>
<p>It is possible to check if the dialog is displayed, as well as to reject or grant permission.</p>
<div class="highlight"><pre><span></span><code><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">isDialogVisible</span><span class="p">())</span>
<span class="w">    </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">allowViaDialog</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>In this way, we will make sure that the dialog is displayed and agree to making calls.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<p>As a reminder, the dialog will be shown on Android API version 23 and above, how to run these tests on earlier versions, we will explain at the end of this tutorial.</p>
<p>Here we have written <code>device.permissions</code> twice, let's shorten the code a bit by using the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/apply.html">apply</a> function. And let's move the check through <code>assert</code> to the <code>flakySafely</code> method. Then the whole test code will look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Let's run the test. Test passed successfully.</p>
<p>Now we can easily write a test for the fact that the call is not made if permission was not given. To do this, instead of <code>allowViaDialog</code> you need to specify <code>denyViaDialog</code>.</p>
<p>You also need to change the checks in the test itself, and do not forget to remove the code from the <code>after</code> function in the new method, since after the permission is denied, the call will not be made, and after the test, you no longer need to reset the call.</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="testing-against-different-api-versions">Testing against different API versions</h2>
<p>On modern versions of the Android OS (API 23 and higher), permissions are requested from the user during the application through a dialog. But in earlier versions, they were requested at the time of installation of the application, and during operation it was considered that the user agreed with all the required permissions.</p>
<p>Therefore, if you run the test on devices with API below version 23, then there will be no request for permissions, so the dialog check is not required.</p>
<p>In the test using <code>GrantPermissionRule</code> no changes are required, on older versions the permission is always there, so this annotation will not affect the test in any way. But in the test using <code>device.permissions</code>, changes need to be made, because here we are explicitly checking the operation of the dialog.</p>
<p>There are several options here. Firstly, on such devices it makes no sense to test the application if the permission was denied, so this test should simply be skipped. To do this, you can use the <code>@SuppressSdk</code> annotation. Then the code of the <code>checkCallIfPermissionDenied</code> method will change to:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SdkSuppress</span><span class="p">(</span><span class="n">minSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span><span class="p">)</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Now this test will be performed only on new versions of the Android OS, and on older versions it will be skipped.</p>
<p>The second solution for the problem is to skip certain steps or replace them with others, depending on the API level. For example, in the <code>checkSuccessCall</code> method on old devices, we can skip the step with checking the dialog, for this use the following code:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION</span><span class="p">.</span><span class="na">SDK_INT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The rest of the code can be left untouched and the test will run successfully on both new and old devices, just in one case permission will be requested, in the other it won't.</p>
<p>The final test code will now look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.os.Build</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.filters.SdkSuppress</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION</span><span class="p">.</span><span class="na">SDK_INT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                        </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@SdkSuppress</span><span class="p">(</span><span class="n">minSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="summary">Summary</h2>
<p>In this tutorial, we have looked at two options for working with Permissions: <code>GrantPermissionRule</code> and <code>device.permissions</code>.</p>
<p>We also learned that the second option is preferable for a number of reasons:</p>
<ol>
<li>The Permissions object makes it possible to test whether a dialog requesting permission is displayed</li>
<li>When using Permissions, we can test the application's behavior not only when accepting a permission, but also when denying it</li>
<li>Tests with the GrantPermissionRule will fail if the permission was previously denied. You will need to reinstall the application or cancel previously issued permissions through the adb shell command </li>
<li>If you revoke the permission using the adb shell command while the test is running, then the test will work correctly if the Permissions object is used, but a crash will occur if the GrantPermissionRule is used</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs", "navigation.tabs", "content.code.annotate", "navigation.tabs.sticky", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>