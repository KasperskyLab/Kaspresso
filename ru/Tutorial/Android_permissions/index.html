
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://kasperskylab.github.io/Kaspresso/ru/Tutorial/Android_permissions/">
      
      
        <link rel="prev" href="../FlakySafely/">
      
      
        <link rel="next" href="../Recyclerview/">
      
      
      <link rel="icon" href="../../../kaspresso.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>10. Работа с Android permissions - Kaspresso</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../" title="Kaspresso" class="md-header__button md-logo" aria-label="Kaspresso" data-md-component="logo">
      
  <img src="../../../kaspresso.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kaspresso
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              10. Работа с Android permissions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/Kaspresso/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/Kaspresso/ru/" hreflang="ru" class="md-select__link">
              Русский
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/KasperskyLab/Kaspresso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Kaspresso
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../" class="md-tabs__link">
          
  
  
  Главная

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Туториал

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Wiki/" class="md-tabs__link">
          
  
  
  Вики

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Issues/" class="md-tabs__link">
          
  
  
  Известные проблемы

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Kaspresso" class="md-nav__button md-logo" aria-label="Kaspresso" data-md-component="logo">
      
  <img src="../../../kaspresso.png" alt="logo">

    </a>
    Kaspresso
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KasperskyLab/Kaspresso" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Kaspresso
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Главная
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Главная
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    О Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso-in-articles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso в статьях
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso-in-videos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kaspresso в видео
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Kaspresso%20users/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Наши пользователи
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Breaking-changes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Критические изменения
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Home/Contribution_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Инструкция для разработчиков
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Туториал
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Туториал
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Введение
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Download_Kaspresso_project_and_Android_studio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2. Скачиваем проект и Android studio
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Writing_simple_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3. Пишем первый автотест с Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Working_with_adb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4. Выполнение adb-команд
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Wifi_sample_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5. Тестирование интернет-соединения и работа с классом Device
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Steps_and_sections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6. Steps and sections
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Scenario/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7. Вынесение дублирующихся шагов в Scenario
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../UiAutomator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8. UiAutomator. Тестирование за рамками приложения
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FlakySafely/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9. flakySafely
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    10. Работа с Android permissions
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    10. Работа с Android permissions
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Создаем тест
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testrule" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование при помощи TestRule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flakysafely-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      FlakySafely для assertions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#devicepermissions" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование при помощи Device.Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование на разных версиях API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Итог
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Recyclerview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11. RecyclerView
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Logger_and_screenshot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12. Логирование и скриншоты
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Screenshot_tests_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13. Screenshot-тесты. Часть 1. Простой screenshot тест
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Screenshot_tests_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14. Screenshot-тесты. Часть 2. Установка стейтов и работа с ViewModel
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Вики
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Вики
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Введение
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Page_object_in_Kaspresso/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Паттерн PageObject в Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Espresso_as_the_basis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Espresso как основа
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Supported_Android_UI_elements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Поддерживаемые UI-виджеты Android
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Matchers_actions_assertions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Доступные классы Matcher, Action и Assertion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kautomator-wrapper_over_UI_Automator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kautomator. Обертка над UI Automator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Working_with_Android_OS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Взаимодействие с ОС Android. Класс Device
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Executing_adb_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Выполнение команд adb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Screenshot_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Скриншот тесты
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Конфигуратор Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_Robolectric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Запуск тестов Kaspresso на JVM с помощью Robolectric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Kaspresso_Allure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Поддержка Allure в Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Wiki/Jetpack_Compose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Поддержка Compose в Kaspresso
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Известные проблемы
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Известные проблемы
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Нашли проблему?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Issues/Storage_issue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Работа с файлами
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Создаем тест
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testrule" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование при помощи TestRule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flakysafely-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      FlakySafely для assertions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#devicepermissions" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование при помощи Device.Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      Тестирование на разных версиях API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Итог
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">Тестирование приложений, требующих разрешений</h1>
<p>В этом уроке мы научимся работать с разрешениями (<a href="https://developer.android.com/guide/topics/permissions/overview">Permissions</a>). </p>
<p>Часто для корректной работы приложению нужен доступ к определенным функциям мобильного устройства: к камере, записи голоса, совершению звонков, отправке SMS-сообщений и т.д. Приложение может получить доступ к ним и использовать только в том случае, если пользователь даст на это разрешение.</p>
<p>На старых устройствах ниже шестой версии Android (API level 23) такие разрешения запрашивались в момент установки приложения и, если пользователь установил его, то считалось, что он согласен со всеми разрешениями, и приложение будет иметь возможность использовать все необходимые функции. Это было небезопасно, так как открывало возможность недобросовестным разработчикам незаметно для пользователя получать доступ к микрофону, камере, звонкам и другим важным компонентам и использовать в своих целях. </p>
<p>По этой причине на более новых версиях так называемые «опасные» разрешения стали запрашиваться не в момент установки, а во время работы приложения. Теперь пользователь явно будет видеть диалог с предложением разрешить или отклонить запрос на использование какой-то функциональности.</p>
<p>Для примера запустите приложение <code>tutorial</code> на одной из последних версий Android (API 23 и выше) и нажмите кнопку <code>Make Call Activity</code> </p>
<p><img src="../images/permissions/main_screen.png" alt="Main Screen" width="300"/></p>
<p>У вас откроется экран, на котором есть два элемента – поле ввода и кнопка. В поле ввода можно указать какой-то номер телефона и кликнуть на кнопку <code>Make Call</code> для осуществления вызова</p>
<p><img src="../images/permissions/make_call_screen.png" alt="Make call screen" width="300"/></p>
<p>Совершение звонков – одна из функций, для работы которой требуется запросить разрешение у пользователя. Поэтому у вас отобразится диалог с предложением позволить приложению управлять звонками, на котором есть кнопки «Разрешить» и «Отклонить»</p>
<p><img src="../images/permissions/request_permission_1.png" alt="Request permissions" width="300"/></p>
<p>Если мы нажмем “Allow”, то начнется вызов абонента по тому номеру, который вы указали в поле ввода</p>
<p><img src="../images/permissions/call_1.png" alt="Calling" width="300"/></p>
<p>При следующем открытии приложения разрешение больше не будет запрашиваться, оно сохраняется на устройстве. Если вы хотите отозвать разрешение, то можно это сделать в настройках. Для этого перейдите в раздел приложения, найдите нужное вам и заходите в раздел <code>Permissions</code></p>
<p><img src="../images/permissions/deny_permission_settings.png" alt="Deny permission" width="300"/></p>
<p>Здесь вы сможете зайти в любое разрешение и изменить значение с <code>Allow</code> на <code>Deny</code> или наоборот.</p>
<p>Второй способ, как это можно сделать – при помощи adb shell команды: </p>
<p><code>adb shell pm revoke package_name permission_name</code></p>
<p>Для нашего приложения команда будет выглядеть так:</p>
<p><code>adb shell pm revoke com.kaspersky.kaspresso.tutorial android.permission.CALL_PHONE</code></p>
<p>После выполнения команды приложение снова запросит разрешение при следующей попытке совершить звонок.</p>
<h2 id="_2">Создаем тест</h2>
<p>При тестировании приложений, которое требует разрешений, есть определенные особенности. Давайте напишем тест на данный экран.</p>
<p>Первым делом создадим Page Object экрана с кнопкой <code>Make Call</code></p>
<p><div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen</span>

<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.screens.KScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.R</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.edit.KEditText</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.text.KButton</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">MakeCallActivityScreen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KScreen</span><span class="o">&lt;</span><span class="n">MakeCallActivityScreen</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">layoutId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewClass</span><span class="p">:</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;*&gt;?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">inputNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEditText</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">input_number</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">makeCallButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Чтобы попасть на этот экран, нужно будет в <code>MainActivity</code> кликнуть по соответствующей кнопке, добавляем эту кнопку в <code>MainScreen</code> </p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen</span>

<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.screens.KScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.R</span>
<span class="k">import</span><span class="w"> </span><span class="nn">io.github.kakaocup.kakao.text.KButton</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">MainScreen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">KScreen</span><span class="o">&lt;</span><span class="n">MainScreen</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">layoutId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewClass</span><span class="p">:</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;*&gt;?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">simpleActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">simple_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">wifiActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">wifi_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">loginActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">login_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">notificationActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">notification_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">makeCallActivityButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KButton</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">withId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">make_call_activity_btn</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Можем создавать тест. Давайте пока просто откроем экран совершения звонка, введем какой-то номер и кликнем по кнопке</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Запускаем тест. Тест пройден успешно.</p>
<p>В зависимости от того, дали вы разрешение или нет, у вас может отобразиться диалог с запросом разрешения на совершение звонков.</p>
<p>На данном этапе мы проверили работу нашего экрана, что есть возможность ввести номер и кликнуть на кнопку, но никак не проверили, происходит вызов по введенному номеру или нет. Для того чтобы проверить, происходит ли в данный момент вызов можно использовать <code>AudioManager</code>, делается это следующим образом:</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
</code></pre></div>
Можем добавить эту проверку отдельным шагом:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">AudioManager</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Перед запуском теста удалите приложение с устройства или отзовите разрешения при помощи adb shell команды. Также убедитесь, что вы запускаете тест на устройстве с API 23 и выше</p>
</div>
<p>Запускаем тест. Тест провален.</p>
<p>Это произошло, потому что после клика по кнопке у пользователя было запрошено разрешение. Никто этого разрешения не дал, и следующий экран открыт не был. </p>
<h2 id="testrule">Тестирование при помощи TestRule</h2>
<p>Есть несколько вариантов решения проблемы. Первый вариант – использовать <code>GrantPermissionRule</code>. Суть этого способа заключается в том, что мы создаем список разрешений, которые будут автоматически разрешены на тестируемом устройстве.</p>
<p>Для этого перед тестовым методом мы добавляем новое правило:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">    </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="p">)</span>
</code></pre></div>
<p>В методе <code>grant</code> в круглых скобках мы через запятую перечисляем все требуемые разрешения, в данном случае оно всего одно, поэтому оставляем в таком виде. Тогда весь код теста будет выглядеть так:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Перед запуском теста не забудьте отозвать все разрешения у приложения или удалить его с устройства.</p>
</div>
<p>Запускаем. В некоторых случаях этот тест будет пройдет успешно, а в некоторых – нет. Причину мы сейчас разберем.</p>
<h2 id="flakysafely-assertions">FlakySafely для assertions</h2>
<p>Вспомните урок про метод <code>flakySafely</code>. Там мы говорили о том, что в случае неудачи все проверки в Kaspresso будут запускаться заново в течение определенного таймаута.</p>
<p>В нашем случае мы стартуем звонок и следующим шагом проверяем, что телефон действительно звонит. Делаем это мы через метод <code>Assert.assertTrue(…)</code>. Иногда устройство успевает осуществить набор номера до этой проверки, а иногда нет. Кажется, что в такой ситуации должен отрабатывать метод <code>flakySafely</code> и проверка должна быть проведена заново в течение десяти секунд, но почему-то этого не происходит.</p>
<p>Дело в том, что все проверки view-элементов в Kaspresso (isVisible, isClickable…) «под капотом» используют метод <code>flakySafely</code>, но если мы сами вызываем различные проверки через <code>assert</code>, то <code>flakySafely</code> использован не будет и, если проверка выполнится неудачно, то тест сразу завершится с ошибкой.</p>
<p>Такие случаи – это еще один пример, когда стоит явно вызывать <code>flakySafely</code></p>
<p><div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="s">&quot;111&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Сейчас тест работает, но в нем есть несколько проблем. </p>
<p>Во-первых, после окончания теста на устройстве все еще продолжается вызов абонента. Давайте добавим секции <code>before</code> и <code>after</code> и в секции, которая выполняется после теста, завершим вызов. Это можно сделать при помощи следующего кода:  <code>device.phone.cancelCall("111")</code>. Работает этот метод посредством adb-команд, поэтому не забывайте запускать adb-сервер. </p>
<p>Теоретически, вы могли бы сброс звонка вынести в отдельный step и запускать его последним шагом, не вынося в секцию after. Но это было бы плохим решением, поскольку в случае, если какой-то шаг завершится с ошибкой, и тест будет провален, то на устройстве будет продолжен вызов и никогда не сбросится. Преимущество секции after в том, что код внутри этого блока выполнится независимо от результата теста.</p>
<p>Чтобы не дублировать один и тот же номер в двух местах, давайте вынесем его в отдельную переменную, тогда код теста будет выглядеть так:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.rule.GrantPermissionRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">grantPermissionRule</span><span class="p">:</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantPermissionRule</span><span class="p">.</span><span class="na">grant</span><span class="p">(</span>
<span class="w">        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">CALL_PHONE</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Теперь после выполнения теста звонок завершается. </p>
<p>Вторая проблема – при использовании <code>GrantPermissionRule</code> мы можем проверить приложение только в состоянии, когда пользователь дал разрешение. При этом есть вероятность, что разработчики не предусмотрели вариант, когда запрос разрешения был отклонен, тогда результат может быть неожиданным вплоть до того, что приложение будет крашиться. Необходимо проверять и такие сценарии, но использовать для этого <code>GrantPermissionRule</code> не получится, так как в этом случае разрешение всегда будет одобрено, и в тестах мы никогда не узнаем, какое будет поведение, если запрос отклонить.</p>
<h2 id="devicepermissions">Тестирование при помощи Device.Permissions</h2>
<p>Один из вариантов решения проблемы - взаимодействовать с диалогом при помощи KAutomator, предварительно найдя все необходимые элементы интерфейса, но это не слишком удобно, и в Kaspresso был добавлен намного более удобный способ - <code>Device.Permissions</code>. Он позволяет очень просто проверять диалоги разрешений, а также соглашаться с ними или отклонять. </p>
<p>Поэтому вместо <code>Rule</code> мы будем использовать объект <code>Permissions</code>, который можно получить у <code>Device</code>. Давайте сделаем это в отдельном классе, чтобы у вас сохранились оба варианта тестов. Класс, в котором мы сейчас работаем, переименуем в <code>MakeCallActivityRuleTest</code>. </p>
<p>Чтобы это сделать, кликните правой кнопкой на название файла и выберите <code>Refactor</code> -&gt; <code>Rename</code></p>
<p><img src="../images/permissions/rename.png" alt="Rename" /></p>
<p>И введите новое название класса:</p>
<p><img src="../images/permissions/rename_2.png" alt="Rename" /></p>
<p>И создаем новый класс <code>MakeCallActivityDevicePermissionsTest</code>. Код можно скопировать из текущего теста, за исключением <code>GrantPermissionRule</code></p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Если мы запустим тест сейчас, то он завершится неудачно, т.к. мы не дали разрешений на совершение звонков. Давайте добавим еще один step, в котором дадим соответствующее разрешение через <code>device.permissions</code>. После указания объекта можно поставить точку и посмотреть, какие у него есть методы:</p>
<p><img src="../images/permissions/device_perm_methods.png" alt="Device permission methods"/></p>
<p>Есть возможность проверить, отображается ли диалог, а также отклонить или дать разрешение.</p>
<div class="highlight"><pre><span></span><code><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">isDialogVisible</span><span class="p">())</span>
<span class="w">    </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">allowViaDialog</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>Таким образом мы убедимся, что диалог отображается и дадим согласие на осуществление звонков. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Напоминаем, что диалог будет показан на версии Android API 23 и выше, как выполнять эти тесты на более ранних версиях, мы разберем в конце этого урока</p>
</div>
<p>Тут мы дважды написали <code>device.permissions</code>, давайте немного сократим код, применив функцию <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/apply.html">apply</a>. А также проверку через <code>assert</code> давайте вынесем в метод <code>flakySafely</code>. Тогда весь код теста будет выглядеть так:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Запускаем. Тест пройден успешно.</p>
<p>Теперь мы можем с легкостью написать тест на то, что звонок не осуществляется, если разрешение дано не было. Для этого вместо <code>allowViaDialog</code> нужно указать <code>denyViaDialog</code>. </p>
<p>Также нужно изменить проверки в самом тесте, и не забудьте в новом методе удалить код из функции <code>after</code>, так как после отклонения разрешения звонок осуществлен не будет, и после теста сбрасывать звонок больше не нужно.</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="api">Тестирование на разных версиях API</h2>
<p>На современных версиях ОС Android (API 23 и выше) разрешения у пользователя запрашиваются во время работы приложения посредством диалога. Но в более ранних версиях они запрашивались в момент установки приложения, а во время работы считалось, что пользователь согласился со всеми требуемыми разрешениями.</p>
<p>Поэтому, если вы запускаете тест на устройствах с API ниже 23-ой версии, то никакого запроса разрешений не будет, соответственно проверка диалога не требуется. </p>
<p>В тесте с использованием <code>GrantPermissionRule</code> никаких изменений не требуется, на старых версиях разрешение всегда есть, поэтому данная аннотация на работе теста никак не скажется. Но в тесте с использованием <code>device.permissions</code> изменения сделать необходимо, так как здесь мы явно проверяем работу диалога.</p>
<p>Вариантов здесь несколько. Во-первых, на таких устройствах нет смысла проверять работу приложения, если разрешение было отклонено, поэтому данный тест нужно просто пропускать. Для этого можно воспользоваться аннотацией <code>@SuppressSdk</code>. Тогда код метода <code>checkCallIfPermissionDenied</code> изменится на:</p>
<p><div class="highlight"><pre><span></span><code><span class="nd">@SdkSuppress</span><span class="p">(</span><span class="n">minSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span><span class="p">)</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Теперь данный тест будет выполняться только на новых версиях ОС Android, а на старых будет пропускаться.</p>
<p>Второй вариант решения проблемы – пропускать какие-то определенные шаги или заменять их другими в зависимости от уровня API. Например, в методе <code>checkSuccessCall</code> на старых девайсах мы можем пропустить шаг с проверкой диалога, для этого использовать такой код:</p>
<p><div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION</span><span class="p">.</span><span class="na">SDK_INT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Остальную часть кода можно не трогать и тест будет успешно прогоняться, как на новых, так и на старых устройствах, просто в одном случае разрешение будет запрошено, в другом – нет.</p>
<p>Финальный код теста теперь будет выглядеть так:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial</span>

<span class="k">import</span><span class="w"> </span><span class="nn">android.content.Context</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.media.AudioManager</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.os.Build</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.ext.junit.rules.activityScenarioRule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.test.filters.SdkSuppress</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.testcases.api.testcase.TestCase</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MainScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.kaspersky.kaspresso.tutorial.screen.MakeCallActivityScreen</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Rule</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.junit.Test</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">MakeCallActivityDevicePermissionsTest</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">activityRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityScenarioRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">testNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;111&quot;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkSuccessCall</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}.</span><span class="na">after</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">device</span><span class="p">.</span><span class="na">phone</span><span class="p">.</span><span class="na">cancelCall</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION</span><span class="p">.</span><span class="na">SDK_INT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Accept permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                        </span><span class="n">allowViaDialog</span><span class="p">()</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check phone is calling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">AUDIO_SERVICE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AudioManager</span>
<span class="w">                </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AudioManager</span><span class="p">.</span><span class="na">MODE_IN_CALL</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@SdkSuppress</span><span class="p">(</span><span class="n">minSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkCallIfPermissionDenied</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Open make call activity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MainScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">makeCallActivityButton</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">isVisible</span><span class="p">()</span>
<span class="w">                    </span><span class="n">isClickable</span><span class="p">()</span>
<span class="w">                    </span><span class="n">click</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check UI elements&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">hasHint</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">phone_number_hint</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isVisible</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isClickable</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">make_call_btn</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Try to call number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">replaceText</span><span class="p">(</span><span class="n">testNumber</span><span class="p">)</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">click</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Deny permission&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">device</span><span class="p">.</span><span class="na">permissions</span><span class="p">.</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flakySafely</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">isDialogVisible</span><span class="p">())</span>
<span class="w">                    </span><span class="n">denyViaDialog</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">step</span><span class="p">(</span><span class="s">&quot;Check stay on the same screen&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MakeCallActivityScreen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">inputNumber</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">                </span><span class="n">makeCallButton</span><span class="p">.</span><span class="na">isDisplayed</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_3">Итог</h2>
<p>В этом уроке мы рассмотрели два варианта работы с Permissions: <code>GrantPermissionRule</code> и <code>device.permissions</code>. </p>
<p>Также мы узнали, что второй вариант предпочтительнее по ряду причин:</p>
<ol>
<li>Объект Permissions дает возможность проверять отображение диалога с запросом разрешения</li>
<li>При использовании Permissions мы можем проверить поведение приложения не только при принятии разрешения, но также и при его отклонении</li> 
<li>Тесты с применением GrantPermissionRule не будут работать, если разрешение было ранее отклонено. Потребуется переустановка приложения либо отмена выданных ранее разрешений через adb shell команду</li> 
<li>Если во время выполнения теста отозвать разрешение при помощи adb shell команды, то в случае использования объекта Permissions тест будет работать корректно, а в случае использования GrantPermissionRule произойдет краш</li> 
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs", "navigation.tabs", "content.code.annotate", "navigation.tabs.sticky", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>